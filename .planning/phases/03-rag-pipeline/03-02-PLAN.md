---
phase: 03-rag-pipeline
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/server/lib/coaching.ts
  - src/server/routes/chat.ts
  - src/server/routes/rag.ts
  - src/server/index.ts
  - src/client/components/ChatMessage.tsx
  - src/client/hooks/useChat.ts
autonomous: true
requirements: [RAG-03, RAG-04]

must_haves:
  truths:
    - "When generating a workout, the AI retrieves relevant past training context and cites specific past sessions"
    - "The user can see which past sessions the AI referenced via an expandable Sources section"
    - "New messages (both user and AI) are automatically embedded in ChromaDB after each exchange"
    - "If ChromaDB is unavailable, the app falls back to Phase 2 behavior gracefully"
  artifacts:
    - path: "src/server/lib/coaching.ts"
      provides: "RAG-augmented system prompt with retrieved training history"
      exports: ["buildSystemPrompt"]
    - path: "src/server/routes/chat.ts"
      provides: "Write-back hooks embedding new messages after persistence"
    - path: "src/server/routes/rag.ts"
      provides: "Import status endpoint, RAG health check"
      exports: ["default"]
    - path: "src/client/components/ChatMessage.tsx"
      provides: "Expandable Sources used section showing retrieved session snippets"
  key_links:
    - from: "src/server/lib/coaching.ts"
      to: "src/server/lib/rag.ts"
      via: "retrieveRelevantSessions import"
      pattern: "import.*retrieveRelevantSessions.*from.*rag"
    - from: "src/server/routes/chat.ts"
      to: "src/server/lib/rag.ts"
      via: "embedAndStore for write-back"
      pattern: "import.*embedAndStore.*from.*rag"
    - from: "src/server/routes/chat.ts"
      to: "SSE sources event"
      via: "writeSSE with sources data before done event"
      pattern: "writeSSE.*sources"
    - from: "src/client/components/ChatMessage.tsx"
      to: "sources prop"
      via: "collapsible details element rendering source snippets"
      pattern: "sources.*map|<details"
---

<objective>
Integrate RAG retrieval into the AI coaching pipeline and add automatic write-back so every conversation enriches the knowledge base.

Purpose: This wires the memory layer built in Plan 01 into the existing chat and workout generation flows. The AI now retrieves relevant past sessions before responding, explicitly cites past workouts, and shows the user what context it used. Every new exchange is automatically embedded so the knowledge base grows with each conversation.

Output: Modified coaching system prompt with RAG context, write-back hooks in chat routes, Sources UI on AI messages, RAG status endpoint.
</objective>

<execution_context>
@/home/mcook/.claude/get-shit-done/workflows/execute-plan.md
@/home/mcook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-rag-pipeline/03-RESEARCH.md
@.planning/phases/03-rag-pipeline/03-01-SUMMARY.md
@src/server/lib/coaching.ts
@src/server/routes/chat.ts
@src/server/lib/chroma.ts
@src/server/lib/rag.ts
@src/client/components/ChatMessage.tsx
@src/client/hooks/useChat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RAG-augmented system prompt and write-back hooks</name>
  <files>src/server/lib/coaching.ts, src/server/routes/chat.ts, src/server/routes/rag.ts, src/server/index.ts</files>
  <action>
**Modify `src/server/lib/coaching.ts`:**
- Change `buildSystemPrompt()` signature to accept optional `userMessage?: string` parameter (backward-compatible)
- When `userMessage` is provided, call `retrieveRelevantSessions(userMessage, 5)` from `../lib/rag.js`
- If retrieval returns results, build a `## Relevant Training History (from memory)` section in the system prompt with each result formatted as: `### {date} session (relevance: {score}%)\n{snippet}`
- Add guidelines to the system prompt: "When referencing past workouts from memory, cite the date and specific details" and "Include a 'Sources used' section at the end listing which past sessions informed your response"
- When no relevant history exists, omit the section entirely (per user decision: AI coaches normally without flagging the gap)
- Return both the system prompt string AND the retrieved sources array (change return type to `{ prompt: string, sources: Array<{ date: string, snippet: string, score: number }> }`)
- Wrap the retrieval call in try/catch -- if ChromaDB is down, log a warning and proceed with the Phase 2 behavior (profile + recent workouts only, no RAG context). This is the graceful degradation path.

**Modify `src/server/routes/chat.ts`:**
- In POST /send: call `buildSystemPrompt(body.message)` instead of `buildSystemPrompt()` to get RAG context. Destructure `{ prompt, sources }`.
- After streaming completes and before the `done` SSE event, send a `sources` SSE event with the retrieved sources array: `await stream.writeSSE({ data: JSON.stringify({ type: 'sources', sources }), event: 'message' })`
- After `db.insert(messages)` for both user and AI messages, add a fire-and-forget write-back: `embedAndStore(body.message, fullText, { date: new Date().toISOString().split('T')[0], exercises: extractMetadata(body.message + ' ' + fullText).exercises, muscleGroups: extractMetadata(body.message + ' ' + fullText).muscleGroups, type: 'live-session' }).catch(err => console.warn('RAG write-back failed:', err))`
- Import `embedAndStore` and `extractMetadata` from `../lib/rag.js`

- In POST /generate-workout: call `buildSystemPrompt(body.prompt)` for RAG context. Include sources in the response JSON alongside workout, plan, and warnings.
- After `db.insert(messages)` in generate-workout, add the same fire-and-forget write-back pattern.

**Create `src/server/routes/rag.ts`:**
- GET /status: Return ChromaDB health (use `checkChromaHealth()` from chroma.ts) and collection count
- GET /collection-info: Return collection count and a sample of recent chunk metadata (last 5 by date)
- This endpoint is for debugging/monitoring, not user-facing

**Modify `src/server/index.ts`:**
- Mount the rag routes: `app.route('/api/rag', ragRoutes)`
- On server startup, call `checkChromaHealth()` and log result: "ChromaDB: connected (N chunks)" or "ChromaDB: unavailable -- RAG disabled, using profile-only mode"
  </action>
  <verify>
Start the server. Send a chat message via curl: `curl -X POST http://localhost:3001/api/chat/send -H 'Content-Type: application/json' -d '{"message":"What should I squat today?"}'` -- SSE stream should include a `sources` event with relevant past sessions before the `done` event. Check `curl http://localhost:3001/api/rag/status` returns health info. Verify the write-back by checking ChromaDB collection count increased after sending a message.
  </verify>
  <done>buildSystemPrompt retrieves relevant past training context when given a user message. Chat streaming sends sources to the client via SSE. Both /send and /generate-workout persist new exchanges to ChromaDB automatically. RAG status endpoint reports ChromaDB health and collection size. If ChromaDB is down, the app falls back to Phase 2 behavior without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Sources UI on chat messages</name>
  <files>src/client/components/ChatMessage.tsx, src/client/hooks/useChat.ts</files>
  <action>
**Modify `src/client/hooks/useChat.ts`:**
- Update the message type to include optional `sources` field: `sources?: Array<{ date: string, snippet: string, score: number }>`
- In the SSE consumer, handle the new `type: 'sources'` event: store the sources array and attach it to the AI message when the `done` event arrives
- The flow is: chunks stream in -> `sources` event arrives with the array -> `done` event arrives -> finalize message with sources attached

**Modify `src/client/components/ChatMessage.tsx`:**
- Add `sources` to the ChatMessageProps interface: `sources?: Array<{ date: string, snippet: string, score: number }>`
- Below the message text (only for `model` role messages that have sources), render a collapsible "Sources used" section:
  - Use an HTML `<details>` element (native collapsible, no JS needed)
  - `<summary>` text: "Sources used ({N})" styled subtly (smaller font, muted color, var(--text-muted) or similar)
  - Inside: list each source as a compact entry: "{date} ({score}% relevant)" on one line, then a 1-2 line snippet preview in smaller text
  - Truncate snippet to ~150 chars for display, with ellipsis
- Style the sources section:
  - Font-size: 0.8rem
  - Color: muted text (not the main message color)
  - Padding-top: 0.5rem, border-top: 1px solid subtle border color
  - The `<details>` should be collapsed by default (standard HTML behavior)
  - When open, snippets use a slightly different background (e.g., var(--surface-alt) or similar)
- When no sources exist on an AI message, don't render the section at all (per user decision: no gap flagging)
  </action>
  <verify>
Open the app in the browser. Send a message asking about a specific exercise (e.g., "What did I bench press recently?"). The AI response should stream normally, then after completion, a "Sources used (N)" collapsible section should appear below the message text. Click to expand -- should show past session dates, relevance scores, and snippet previews. Messages without sources should have no sources section.
  </verify>
  <done>AI messages display an expandable "Sources used" section showing which past sessions were retrieved. Sources show date, relevance percentage, and snippet preview. The section is collapsed by default, non-intrusive, and only appears when sources exist. Messages without sources show no extra UI.</done>
</task>

</tasks>

<verification>
1. Chat message about "squats" triggers retrieval and AI cites specific past squat sessions
2. Sources SSE event arrives before done event in streaming responses
3. Sources UI shows collapsible section with date, score, and snippet for each retrieved session
4. New messages appear in ChromaDB collection count after sending (write-back works)
5. Stopping ChromaDB server -> app still works (falls back to profile-only mode, no errors)
6. /api/rag/status returns health and count
7. Workout generation also includes sources in response
</verification>

<success_criteria>
- AI coaching quality visibly improves: references specific past workouts by date and details
- Users see what context the AI used via expandable Sources section
- Every new conversation exchange is automatically embedded in the knowledge base
- The system degrades gracefully when ChromaDB is unavailable
</success_criteria>

<output>
After completion, create `.planning/phases/03-rag-pipeline/03-02-SUMMARY.md`
</output>
