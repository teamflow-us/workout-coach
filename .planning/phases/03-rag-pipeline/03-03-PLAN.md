---
phase: 03-rag-pipeline
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/client/hooks/useChat.ts
autonomous: true
requirements: [RAG-01, RAG-02, RAG-03, RAG-04]
gap_closure: true

must_haves:
  truths:
    - "When a user generates a workout via the Generate Workout button, the AI message displays a Sources section showing which past sessions were retrieved"
    - "The Sources UI for workout generation matches the existing Sources UI for streaming chat messages"
  artifacts:
    - path: "src/client/hooks/useChat.ts"
      provides: "GenerateWorkoutResponse includes sources; aiMsg built with sources attached"
      contains: "sources"
  key_links:
    - from: "src/client/hooks/useChat.ts"
      to: "GenerateWorkoutResponse.sources"
      via: "data.sources read from JSON response and attached to aiMsg"
      pattern: "sources.*data\\.sources"
---

<objective>
Fix the generate-workout Sources UI gap: the server returns sources in its JSON response but the client ignores them.

Purpose: Closes the one partial verification gap from Phase 3. The streaming chat path correctly displays Sources, but the workout generation path drops them because `GenerateWorkoutResponse` lacks the `sources` field and `aiMsg` is built without it.

Output: Updated `useChat.ts` where workout generation AI messages include sources from the server response.
</objective>

<execution_context>
@/home/mcook/.claude/get-shit-done/workflows/execute-plan.md
@/home/mcook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-rag-pipeline/03-VERIFICATION.md
@src/client/hooks/useChat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire sources into generate-workout client path</name>
  <files>src/client/hooks/useChat.ts</files>
  <action>
Two targeted edits in `src/client/hooks/useChat.ts`:

1. **Add `sources` to `GenerateWorkoutResponse` interface** (around line 16):
   Add `sources?: Array<{ date: string; snippet: string; score: number }>` as a field in the `GenerateWorkoutResponse` interface, after the `warnings` field. The server's `/api/chat/generate-workout` endpoint already returns this field in its JSON response alongside `workout`, `plan`, and `warnings`.

2. **Attach sources to `aiMsg` in `generateWorkout` function** (around line 230-234):
   When building the `aiMsg: ChatMessage` object inside the `generateWorkout` function, add `sources: data.sources ?? []` to the object literal. Currently the `aiMsg` only has `role`, `text`, and `timestamp`. Adding `sources` will cause the existing `ChatMessage` component (which already renders sources via the `<details>` element) to display the Sources section for workout generation messages.

No other changes needed. The `ChatMessage` type already has `sources?: ChatSource[]`, the `ChatMessage.tsx` component already renders sources when present, and the server already returns sources in the response. This is purely a client-side data plumbing fix.
  </action>
  <verify>
Open the app in the browser. Click "Generate Workout" (or send a workout generation prompt). After the AI responds with a structured workout, verify that a "Sources used (N)" collapsible section appears below the workout summary -- matching the same Sources UI that already appears on streaming chat messages. If ChromaDB has relevant past sessions, N should be > 0 and expanding should show dates, relevance percentages, and snippet previews.

Alternatively verify via code inspection: `GenerateWorkoutResponse` interface includes `sources?` field, and the `aiMsg` object in `generateWorkout` includes `sources: data.sources ?? []`.
  </verify>
  <done>Workout generation AI messages display the Sources section when the server returns retrieved past sessions. The Sources UI is identical to the streaming chat path -- collapsible, showing date, relevance %, and snippet preview per source.</done>
</task>

</tasks>

<verification>
1. `GenerateWorkoutResponse` interface includes `sources?: Array<{ date: string; snippet: string; score: number }>`
2. `aiMsg` in `generateWorkout` function includes `sources: data.sources ?? []`
3. No TypeScript errors in `src/client/hooks/useChat.ts`
4. Sources UI appears on workout generation messages in the browser (when past sessions exist)
</verification>

<success_criteria>
- The one partial gap from 03-VERIFICATION.md is fully closed
- All 7/7 must-haves from Phase 3 verification are now satisfied
- Workout generation and streaming chat both show Sources UI consistently
</success_criteria>

<output>
After completion, create `.planning/phases/03-rag-pipeline/03-03-SUMMARY.md`
</output>
