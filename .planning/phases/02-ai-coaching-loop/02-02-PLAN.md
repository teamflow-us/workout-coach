---
phase: 02-ai-coaching-loop
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/client/components/WorkoutView.tsx
  - src/client/components/ExerciseCard.tsx
  - src/client/components/SetRow.tsx
  - src/client/components/RestTimer.tsx
  - src/client/components/ProfileEditor.tsx
  - src/client/hooks/useRestTimer.ts
  - src/client/hooks/useWakeLock.ts
  - src/client/App.tsx
autonomous: false

must_haves:
  truths:
    - "Today's workout displays exercises with sets, reps, weights, and rest times"
    - "Rest timer counts down between sets with drift-corrected accuracy"
    - "Phone screen stays awake during an active workout"
    - "User can edit their coaching profile (maxes, injuries, equipment, dietary constraints)"
    - "The entire interface is usable on a phone at the gym (large tap targets, readable at arm's length)"
  artifacts:
    - path: "src/client/components/WorkoutView.tsx"
      provides: "Today's workout display with exercises and sets"
      min_lines: 50
    - path: "src/client/components/ExerciseCard.tsx"
      provides: "Single exercise display with set rows"
      min_lines: 30
    - path: "src/client/components/SetRow.tsx"
      provides: "Individual set display (reps, weight, completion status)"
      min_lines: 20
    - path: "src/client/components/RestTimer.tsx"
      provides: "Countdown timer with large display for gym use"
      min_lines: 30
    - path: "src/client/hooks/useRestTimer.ts"
      provides: "Drift-corrected countdown timer hook"
      exports: ["useRestTimer"]
    - path: "src/client/hooks/useWakeLock.ts"
      provides: "Screen Wake Lock API hook"
      exports: ["useWakeLock"]
    - path: "src/client/components/ProfileEditor.tsx"
      provides: "Coaching profile edit form"
      min_lines: 40
  key_links:
    - from: "src/client/components/WorkoutView.tsx"
      to: "/api/workouts"
      via: "fetch GET to load today's workout"
      pattern: "fetch.*api/workouts"
    - from: "src/client/components/RestTimer.tsx"
      to: "src/client/hooks/useRestTimer.ts"
      via: "useRestTimer hook provides remaining, start, stop"
      pattern: "useRestTimer"
    - from: "src/client/components/WorkoutView.tsx"
      to: "src/client/hooks/useWakeLock.ts"
      via: "useWakeLock activated when workout is active"
      pattern: "useWakeLock"
    - from: "src/client/App.tsx"
      to: "src/client/components/WorkoutView.tsx"
      via: "Workout tab renders WorkoutView"
      pattern: "WorkoutView"
---

<objective>
Build the workout display view, rest timer, screen wake lock, and coaching profile editor. This transforms the generated workout data from Plan 01 into a gym-ready interface: exercises with sets visible at a glance, a large countdown timer between sets, screen wake lock to prevent phone sleep, and a profile editor for the user's training context.

Purpose: This is the gym-facing half of Phase 2. After Plan 01, the user can chat and generate workouts. After this plan, the user can USE those workouts at the gym with a purpose-built mobile interface.

Output: WorkoutView with exercise cards and set rows, drift-corrected rest timer, wake lock, profile editor, and full app routing between chat/workout/profile views.
</objective>

<execution_context>
@/home/mcook/.claude/get-shit-done/workflows/execute-plan.md
@/home/mcook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ai-coaching-loop/02-RESEARCH.md
@.planning/phases/02-ai-coaching-loop/02-01-SUMMARY.md
@src/server/db/schema.ts
@src/server/routes/workouts.ts
@src/client/App.tsx
@src/client/styles/global.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Workout view components and data fetching</name>
  <files>
    src/client/components/WorkoutView.tsx
    src/client/components/ExerciseCard.tsx
    src/client/components/SetRow.tsx
  </files>
  <action>
**Create src/client/components/WorkoutView.tsx:**

Today's workout display:
- Fetch the most recent workout from `/api/workouts` (GET list, take first item which is most recent by date desc)
- Then fetch full workout details from `/api/workouts/:id` (includes nested exercises with sets)
- State: currentWorkout (full workout object with exercises and sets), loading boolean, activeExerciseIndex (which exercise the user is currently on)
- Display:
  - Workout header: program name, date
  - List of ExerciseCard components for each exercise
  - Navigation between exercises (prev/next buttons, 48px tap targets)
  - If no workout exists, show a message directing user to the Chat tab to generate one
- Accept optional `workoutId` prop (for when a workout is just generated from chat)
- Pass `onStartRest(seconds)` callback down to SetRow for triggering the rest timer

**Create src/client/components/ExerciseCard.tsx:**

Single exercise display:
- Props: exercise object (name, order, restSeconds, sets array), isActive boolean, onSetComplete callback, onStartRest callback
- Display exercise name prominently (large font, readable at arm's length)
- Show target sets info (e.g., "4 sets x 8 reps @ 185 lbs")
- Render SetRow for each set in the exercise
- Show rest time between sets (e.g., "Rest: 90s")
- Visual distinction for active vs inactive exercise (subtle highlight for active)

**Create src/client/components/SetRow.tsx:**

Individual set row:
- Props: set object (setNumber, reps, weight, rpe, notes), isComplete boolean, onComplete callback, onStartRest callback
- Display: set number, target reps, target weight, RPE if present
- "Done" button (large, 48px tap target) that marks the set complete
- When "Done" is tapped: call onComplete, then call onStartRest with the exercise's restSeconds
- Visual state: pending (default), complete (green check/highlight)
- Keep it simple -- this is a gym interface, not a data entry form
- Weight and reps displayed in large, readable font

**Data types:** Define a shared type for the workout structure returned by the API:
```typescript
interface Workout {
  id: number
  date: string
  programName: string | null
  notes: string | null
  feedback: string | null
  exercises: Exercise[]
}
interface Exercise {
  id: number
  name: string
  order: number
  restSeconds: number | null
  sets: Set[]
}
interface Set {
  id: number
  setNumber: number
  reps: number | null
  weight: number | null
  rpe: number | null
  notes: string | null
}
```

Define these types at the top of WorkoutView.tsx or in a shared types file. Use them consistently.
  </action>
  <verify>
1. Start dev servers: `npm run dev:server` and `npm run dev:client`
2. First generate a workout via the chat (from Plan 01) so data exists
3. Navigate to the Workout tab
4. Verify the most recent workout loads and displays with exercise names, sets, reps, and weights
5. Verify the "Done" button on each set row is at least 48px tall and tappable
6. Verify the "no workout" empty state shows when no workouts exist
  </verify>
  <done>
WorkoutView loads and displays the most recent workout with all exercises and sets. Each exercise shows name, target sets/reps/weight. Each set has a visible "Done" button. Empty state handles no-workout scenario gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rest timer, wake lock, profile editor, and app routing</name>
  <files>
    src/client/hooks/useRestTimer.ts
    src/client/hooks/useWakeLock.ts
    src/client/components/RestTimer.tsx
    src/client/components/ProfileEditor.tsx
    src/client/App.tsx
  </files>
  <action>
**Create src/client/hooks/useRestTimer.ts:**

Follow Pattern 4 from 02-RESEARCH.md exactly:
- State: remaining (seconds), isRunning (boolean)
- endTimeRef: useRef storing the absolute end timestamp (Date.now() + seconds * 1000)
- `start(seconds)`: set endTimeRef, set remaining, set isRunning true
- `stop()`: set isRunning false
- useEffect when isRunning: setInterval at 250ms (4x/sec for smooth display)
  - Each tick: calculate remaining from `Math.max(0, Math.ceil((endTimeRef.current - Date.now()) / 1000))`
  - When remaining hits 0: clearInterval, set isRunning false, call onComplete callback
  - Cleanup: clearInterval on unmount/re-render
- Return: { remaining, isRunning, start, stop }
- The drift correction comes from comparing against absolute end time, not decrementing a counter

**Create src/client/hooks/useWakeLock.ts:**

Follow Pattern 5 from 02-RESEARCH.md exactly:
- wakeLockRef: useRef for WakeLockSentinel
- `request()`: check `'wakeLock' in navigator`, then `navigator.wakeLock.request('screen')`
- `release()`: release the wake lock sentinel
- useEffect: listen for `visibilitychange` events -- re-acquire wake lock when tab becomes visible again (wake lock is released when tab is hidden)
- Return: { request, release }
- Graceful fallback: if Wake Lock API not supported, request() is a no-op

**Create src/client/components/RestTimer.tsx:**

Large countdown display for gym use:
- Props: seconds (number, initial countdown value from exercise restSeconds), onComplete callback
- Uses useRestTimer hook
- Display: remaining time in MM:SS format (or just seconds if < 60), using font-size: 64px (var(--font-size-timer))
- font-variant-numeric: tabular-nums to prevent layout shift as digits change
- "Skip" button to stop the timer early (48px tap target)
- Visual feedback: color changes as time runs low (green -> yellow -> red at <10s)
- Show as an overlay or modal when active, dimming the workout view behind it
- When timer completes or is skipped, call onComplete and hide

**Create src/client/components/ProfileEditor.tsx:**

Simple coaching profile form:
- Fetch current profile from `/api/profile` on mount
- Form fields:
  - Maxes: key-value pairs (exercise name -> weight). Start with common lifts (bench, squat, deadlift, overhead press). Allow adding/removing entries.
  - Injuries: text area or tag-like input for injury list
  - Equipment: checkboxes or tags for available equipment (barbell, dumbbells, cable machine, pull-up bar, etc.)
  - Dietary constraints: text tags (gluten-free, dairy-free, etc.)
  - Preferences: days per week (number input), session length in minutes (number input)
- Save button: PUT to `/api/profile` with the form data
- Show save confirmation
- All inputs must have 48px minimum tap targets
- Form should be usable on mobile

**Update src/client/App.tsx:**

Replace the placeholder Workout tab from Plan 01 with the real components:
- Three tabs: "Chat", "Workout", "Profile"
- Chat tab: renders Chat component (from Plan 01)
- Workout tab: renders WorkoutView component with RestTimer overlay
  - When a set is completed and triggers rest, show RestTimer as an overlay
  - Activate wake lock when Workout tab is active, release when switching away
- Profile tab: renders ProfileEditor component
- Tab bar at bottom of screen (mobile-friendly navigation pattern)
  - Fixed position at bottom, 48px tall buttons
  - Icons or text labels for each tab
  - Active tab indicator (accent color underline or background)
- Pass workout generation callback from Chat to Workout (when a workout is generated in chat, switch to Workout tab and show it)
  </action>
  <verify>
1. Start dev servers and open http://localhost:5173
2. Navigate to Workout tab with a generated workout loaded
3. Tap "Done" on a set -- verify the rest timer appears with countdown
4. Verify timer counts down smoothly (updates 4x/sec, no drift)
5. Verify "Skip" button dismisses the timer
6. Navigate to Profile tab -- fill in profile data (bench max: 185, squat max: 275)
7. Save profile -- verify it persists (refresh page, check profile still loaded)
8. On mobile viewport (375px), verify:
   - Bottom tab bar has large tap targets
   - Rest timer numbers are large and readable at arm's length
   - All buttons are at least 48px
   - Chat, Workout, and Profile tabs all render correctly
9. Check that the Workout tab activates wake lock (check navigator.wakeLock in DevTools)
  </verify>
  <done>
Rest timer counts down between sets with drift-corrected accuracy and large visible display. Wake lock keeps screen on during workout. Profile editor allows setting maxes, injuries, equipment, dietary constraints, and preferences. Three-tab navigation (Chat, Workout, Profile) works with bottom tab bar. All elements have 48px minimum tap targets. Full app is usable on a 375px mobile viewport.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete AI coaching loop: streaming chat with Gemini, structured workout generation, freeform logging, today's workout view with exercise cards and sets, drift-corrected rest timer, screen wake lock, coaching profile editor, mobile-first dark theme with 48px tap targets, three-tab navigation (Chat / Workout / Profile).
  </what-built>
  <how-to-verify>
1. Open http://localhost:5173 on your phone (or browser mobile viewport at 375px)
2. Go to Profile tab -- enter your current maxes, injuries, and equipment. Save.
3. Go to Chat tab -- have a conversation with the coach: "Hey coach, I'm ready for a push day. What do you have for me?"
4. Verify the AI response streams in word-by-word (not all at once)
5. Use the "Generate Workout" action to create a structured workout
6. Switch to the Workout tab -- verify the generated workout shows exercises, sets, reps, weights
7. Tap "Done" on a set -- verify the rest timer appears with a large countdown
8. Verify the timer counts down smoothly and disappears when done
9. Refresh the page -- verify chat history is still there
10. Overall: Does this feel usable at the gym? Are tap targets large enough? Is text readable at arm's length? Is the dark theme comfortable?
  </how-to-verify>
  <resume-signal>Type "approved" or describe specific issues to fix</resume-signal>
</task>

</tasks>

<verification>
Phase 2 success criteria check:
1. User can have a natural language conversation with the AI coach and see streaming responses -- verified via Chat tab
2. AI generates a structured workout (exercises, sets, reps, rest, weight) and it displays in today's workout view -- verified via Generate Workout + Workout tab
3. User can log completed sets via freeform text and provide workout feedback -- verified via POST /api/workouts/:id/log endpoint
4. Rest timer counts down between sets during a workout -- verified via RestTimer component
5. The entire interface is usable on a phone screen at the gym -- verified via human checkpoint on mobile viewport
</verification>

<success_criteria>
- Today's workout view renders exercises with sets, reps, weights, and rest times
- Rest timer counts down accurately using drift-corrected absolute time comparison
- Screen stays awake during active workout (Wake Lock API)
- Profile editor saves and loads coaching profile data
- Three-tab navigation works smoothly on mobile
- All interactive elements have 48px minimum tap targets
- Human verification confirms the app is usable at the gym
</success_criteria>

<output>
After completion, create `.planning/phases/02-ai-coaching-loop/02-02-SUMMARY.md`
</output>
